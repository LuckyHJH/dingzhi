<?php/** * ECSHOP 管理中心办事处管理 * ============================================================================ * * 版权所有 2005-2012 上海商派网络科技有限公司，并保留所有权利。 * 网站地址: http://www.ecshop.com； * ---------------------------------------------------------------------------- * 这不是一个自由软件！您只能在不用于商业目的的前提下对程序代码进行修改和 * 使用；不允许对程序代码以任何形式任何目的的再发布。 * ============================================================================ * $Author: liubo $ * $Id: agency.php 17217 2011-01-19 06:29:08Z liubo $ */define('IN_ECS', true);require(dirname(__FILE__) . '/includes/init.php');$exc = new exchange($ecs->table('dealer'), $db, 'dealer_id', 'dealer_name');/*------------------------------------------------------ *///-- 办事处列表/*------------------------------------------------------ */if ($_REQUEST['act'] == 'list'){    $smarty->assign('ur_here',      $_LANG['dealer_list']);    $smarty->assign('action_link',  array('text' => $_LANG['dealer_add'], 'href' => 'dealer.php?act=add'));    $smarty->assign('full_page',    1);    $dealer_list = get_dealerlist();    $smarty->assign('dealer_list',  $dealer_list['dealer']);    $smarty->assign('filter',       $dealer_list['filter']);    $smarty->assign('record_count', $dealer_list['record_count']);    $smarty->assign('page_count',   $dealer_list['page_count']);    /* 排序标记 */    $sort_flag  = sort_flag($dealer_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    assign_query_info();    $smarty->display('dealer_list.htm');}/*------------------------------------------------------ *///-- 排序、分页、查询/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'query'){    $agency_list = get_agencylist();    $smarty->assign('agency_list',  $agency_list['agency']);    $smarty->assign('filter',       $agency_list['filter']);    $smarty->assign('record_count', $agency_list['record_count']);    $smarty->assign('page_count',   $agency_list['page_count']);    /* 排序标记 */    $sort_flag  = sort_flag($agency_list['filter']);    $smarty->assign($sort_flag['tag'], $sort_flag['img']);    make_json_result($smarty->fetch('agency_list.htm'), '',        array('filter' => $agency_list['filter'], 'page_count' => $agency_list['page_count']));}/*------------------------------------------------------ *///-- 列表页编辑名称/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'edit_agency_name'){    check_authz_json('agency_manage');    $id     = intval($_POST['id']);    $name   = json_str_iconv(trim($_POST['val']));    /* 检查名称是否重复 */    if ($exc->num("agency_name", $name, $id) != 0)    {        make_json_error(sprintf($_LANG['agency_name_exist'], $name));    }    else    {        if ($exc->edit("agency_name = '$name'", $id))        {            admin_log($name, 'edit', 'agency');            clear_cache_files();            make_json_result(stripslashes($name));        }        else        {            make_json_result(sprintf($_LANG['agency_edit_fail'], $name));        }    }}/*------------------------------------------------------ *///-- 删除办事处/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'remove'){    check_authz_json('agency_manage');    $id = intval($_GET['id']);    $name = $exc->get_name($id);    $exc->drop($id);    /* 更新管理员、配送地区、发货单、退货单和订单关联的办事处 */    $table_array = array('admin_user', 'region', 'order_info', 'delivery_order', 'back_order');    foreach ($table_array as $value)    {        $sql = "UPDATE " . $ecs->table($value) . " SET agency_id = 0 WHERE agency_id = '$id'";        $db->query($sql);    }    /* 记日志 */    admin_log($name, 'remove', 'agency');    /* 清除缓存 */    clear_cache_files();    $url = 'agency.php?act=query&' . str_replace('act=remove', '', $_SERVER['QUERY_STRING']);    ecs_header("Location: $url\n");    exit;}/*------------------------------------------------------ *///-- 批量操作/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'batch'){    /* 取得要操作的记录编号 */    if (empty($_POST['checkboxes']))    {        sys_msg($_LANG['no_record_selected']);    }    else    {        /* 检查权限 */        admin_priv('agency_manage');        $ids = $_POST['checkboxes'];        if (isset($_POST['remove']))        {            /* 删除记录 */            $sql = "DELETE FROM " . $ecs->table('agency') .                    " WHERE agency_id " . db_create_in($ids);            $db->query($sql);            /* 更新管理员、配送地区、发货单、退货单和订单关联的办事处 */            $table_array = array('admin_user', 'region', 'order_info', 'delivery_order', 'back_order');            foreach ($table_array as $value)            {                $sql = "UPDATE " . $ecs->table($value) . " SET agency_id = 0 WHERE agency_id " . db_create_in($ids) . " ";                $db->query($sql);            }            /* 记日志 */            admin_log('', 'batch_remove', 'agency');            /* 清除缓存 */            clear_cache_files();            sys_msg($_LANG['batch_drop_ok']);        }    }}/*------------------------------------------------------ *///-- 添加、编辑办事处/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'add' || $_REQUEST['act'] == 'edit'){    /* 检查权限 */    admin_priv('agency_manage');    /* 是否添加 */    $is_add = $_REQUEST['act'] == 'add';    $smarty->assign('form_action', $is_add ? 'insert' : 'update');    /* 初始化、取得办事处信息 */    if ($is_add)    {        $dealer = array(            'dealer_id'     => 0,            'dealer_name'   => '',            'mobile'   => '',        );    }    else    {        if (empty($_GET['id']))        {            sys_msg('invalid param');        }        $id = $_GET['id'];        $sql = "SELECT * FROM " . $ecs->table('dealer') . " WHERE dealer_id = '$id'";        $dealer = $db->getRow($sql);        if (empty($dealer))        {            sys_msg('dealer does not exist');        }    }    $smarty->assign('dealer', $dealer);    /* 取得门店 */    $sql = "SELECT * FROM " . $ecs->table('agency');    $agency_list = $db->getAll($sql);    $smarty->assign('agency_list', $agency_list);    /* 显示模板 */    if ($is_add)    {        $smarty->assign('ur_here', $_LANG['dealer_add']);    }    else    {        $smarty->assign('ur_here', '编辑经销商');    }    if ($is_add)    {        $href = 'dealer.php?act=list';    }    else    {        $href = 'dealer.php?act=list&' . list_link_postfix();    }    $smarty->assign('action_link', array('href' => $href, 'text' => $_LANG['dealer_list']));    assign_query_info();    $smarty->display('dealer_info.htm');}/*------------------------------------------------------ *///-- 提交添加、编辑办事处/*------------------------------------------------------ */elseif ($_REQUEST['act'] == 'insert' || $_REQUEST['act'] == 'update'){    /* 检查权限 */    admin_priv('agency_manage');    /* 是否添加 */    $is_add = $_REQUEST['act'] == 'insert';    /* 提交值 */    $dealer = array(        'dealer_id'     => intval($_POST['id']),        'dealer_name'   => sub_str($_POST['dealer_name'], 255, false),        'mobile'        => $_POST['mobile'],        'agency_id'     => $_POST['agency_id'],    );    /* 检查是否选择了门店 */    if (empty($_POST['agency_id']))    {        sys_msg('请选择门店');    }    if (empty($_POST['dealer_name']))    {        sys_msg('请输入名称');    }    if (empty($_POST['mobile']))    {        sys_msg('请输入号码');    }    /* 保存信息 */    if ($is_add)    {        $db->autoExecute($ecs->table('dealer'), $dealer, 'INSERT');        $dealer['dealer_id'] = $db->insert_id();    }    else    {        $db->autoExecute($ecs->table('dealer'), $dealer, 'UPDATE', "dealer_id = '$dealer[dealer_id]'");    }    /* 记日志 */    if ($is_add)    {        admin_log($dealer['dealer_name'], 'add', 'agency');    }    else    {        admin_log($dealer['dealer_name'], 'edit', 'agency');    }    /* 清除缓存 */    clear_cache_files();    /* 提示信息 */    if ($is_add)    {        $links = array(            array('href' => 'dealer.php?act=add', 'text' => '继续添加经销商'),            array('href' => 'dealer.php?act=list', 'text' => '返回经销商列表')        );        sys_msg('添加经销商成功', 0, $links);    }    else    {        $links = array(            array('href' => 'dealer.php?act=list&' . list_link_postfix(), 'text' => '返回经销商列表')        );        sys_msg('编辑经销商成功', 0, $links);    }}/** * 取得经销商列表 * @return  array */function get_dealerlist(){    $result = get_filter();    if ($result === false)    {        /* 初始化分页参数 */        $filter = array();        $filter['sort_by']    = empty($_REQUEST['sort_by']) ? 'dealer_id' : trim($_REQUEST['sort_by']);        $filter['sort_order'] = empty($_REQUEST['sort_order']) ? 'DESC' : trim($_REQUEST['sort_order']);        /* 查询记录总数，计算分页数 */        $sql = "SELECT COUNT(*) FROM " . $GLOBALS['ecs']->table('dealer');        $filter['record_count'] = $GLOBALS['db']->getOne($sql);        $filter = page_and_size($filter);        /* 查询记录 */        $sql = "SELECT * FROM " . $GLOBALS['ecs']->table('dealer') . " ORDER BY $filter[sort_by] $filter[sort_order]";        set_filter($filter, $sql);    }    else    {        $sql    = $result['sql'];        $filter = $result['filter'];    }    $res = $GLOBALS['db']->selectLimit($sql, $filter['page_size'], $filter['start']);    $arr = array();    while ($rows = $GLOBALS['db']->fetchRow($res))    {        $arr[] = $rows;    }    return array('dealer' => $arr, 'filter' => $filter, 'page_count' => $filter['page_count'], 'record_count' => $filter['record_count']);}?>